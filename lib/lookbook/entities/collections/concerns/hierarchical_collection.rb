module Lookbook
  module HierarchicalCollection
    extend ActiveSupport::Concern

    included do
      def entities
        @_cache[:entities] ||= collect_ordered_entities(to_tree(include_hidden: true))
      end

      def to_tree(include_hidden: false)
        @_cache[include_hidden ? :tree_with_hidden : :tree] ||= EntityTreeBuilder.call(@entities, include_hidden: include_hidden)
      end

      protected

      def collect_ordered_entities(start_node)
        start_node.inject([]) do |entities, node|
          entities.append(node.content) if node.content?
          entities.append(collect_ordered_entities(node)) if node.children
        end.flatten
      end
    end
  end
end
